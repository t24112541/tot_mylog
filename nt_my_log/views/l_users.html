<div id="loading" class="spinner_border text-primary" style="display:none"></div>
<!-- Content Column -->
<div class="d-sm-flex align-items-center justify-content-between mb-2">
    <h1 class="h3 mb-0 text-gray-800">ผู้ใช้</h1>
    <div class="">
        <form class="form-inline" id="frm_search">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
                <input id="txt_search" type="text" class="form-control" placeholder="ค้นหา..">
                <button type="button" onclick="func_search()" class="btn btn-light">ค้นหา</button>
            </div>
        </form>
    </div>    
</div>
<div class="row">
    <div class="col-lg-12 mb-4">
        <!-- Project Card  -->
        <div class="card shadow mb-4">
            <div class="card-header d-sm-flex align-items-center justify-content-between mb-2">
                <h6 class="m-0 font-weight-bold text-primary">ผู้ใช้</h6>
                <a class=" d-sm-inline-block btn btn-sm btn btn-secondary shadow-sm" onclick="open_add()" data-toggle="modal" data-target="#modal_l_users"><i class="fas fa-plus-square fa-md text-white"></i></a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ลำดับ</th>
                                <th>ชื่อ-สกุล</th>
                                <th>ตำแหน่ง</th>
                                <th>เบอร์โทร</th>
                                <th>ดู</th>
                            </tr>
                        </thead>
                        <tbody id="l_users_content"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div style="margin-top:10px;">
	<ul class="pagination justify-content-center" id="pagination"></ul>
</div>
<div class="modal fade" id="modal_l_users" >
    <div class="modal-dialog modal-lg" >
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header" id="head_stage">
                <h4 class="modal-title">ผู้ใช้</h4>
                <button type="button" onclick="clear_input()" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            
            <form id="frm_l_users" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
						<div class="col-md-12 mb-12">
									<!-- <label class="cv_keep-left" for="p_id">ตำแหน่ง <span style="color:red">*</span></label> -->
									<div class="input-group" id="p_des">
										<div class="input-group-prepend">
											<span class="input-group-text" ><i class="fas fa-tags"></i></span>
										</div>
										<!-- <div id="p_des"></div> -->
									</div>

						</div>
                        <div class="col-md-12 mb-12">
                            <label class="cv_keep-left" for="u_fullname ">ชื่อ <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
                                <input type="hidden" name="frm_mode" id="frm_mode">
                                <input type="text" class="form-control" id="u_fullname" name="u_fullname" oninvalid="this.setCustomValidity('ชื่อ')"required oninput="this.setCustomValidity('')" placeholder="ชื่อ">
                            </div>
                        </div>
                       
                        <div class="col-md-6 mb-6">
                            <label class="cv_keep-left" for="u_tel">เบอร์โทร <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
                                <input type="text" maxlength="10" class="form-control" id="u_tel" name="u_tel" oninvalid="this.setCustomValidity('เบอร์โทร')"required oninput="this.setCustomValidity('')" placeholder="เบอร์โทร">
                            </div>
                        </div>
                        <div class="col-md-6 mb-6">
                            <label class="cv_keep-left" for="d_id">แผนก <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
                                <div id="hidden"></div>
                                <select class="form-control" id="d_id" name="d_id" required placeholder="เลือกแผนก "></select>                        
                            </div>
                        </div>
                        <div class="col-md-6 mb-6">
                            <label class="cv_keep-left" for="p_id">ตำแหน่ง <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
 
                                <select class="form-control" id="p_id" name="p_id" required ></select>                        
							</div>
							<div class="input-group col-md-12">
                                
								<div id="p_des"></div>
                            </div>
                        </div>
						<div class="col-md-6 mb-6">
                            <label class="cv_keep-left" for="pv_id">จังหวัด <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
 
                                <select class="form-control" id="pv_id" name="pv_id" required placeholder="เลือกจังหวัดผู้ใช้"></select>                        
                            </div>
                        </div>
                        <div class="col-md-6 mb-6">
                            <label class="cv_keep-left" for="u_code">username <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
                                <input type="text" class="form-control" id="u_code" name="u_code" oninvalid="this.setCustomValidity('username')"required oninput="this.setCustomValidity('')" placeholder="username">
                            </div>
                        </div>
                        <div class="col-md-6 mb-6">
                            <label class="cv_keep-left" for="u_password">password <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
                                <input type="password" class="form-control" id="u_password" name="u_password" oninvalid="this.setCustomValidity('password')"required oninput="this.setCustomValidity('')" placeholder="password">
                            </div>
                        </div>
                        <div class="col-md-12 mb-12">
                            <label class="cv_keep-left" for="confirm_u_password">confirm password <span style="color:red">*</span></label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" ><i class="fas fa-tags"></i></span>
                                </div>
                                <input type="password" class="form-control" id="confirm_u_password" name="confirm_u_password" oninvalid="this.setCustomValidity('confirm password')"required oninput="this.setCustomValidity('')" placeholder="confirm password">
                            </div>
                        </div>
                    </div>
                    
                    
                    <div id="frm"></div>
                    <div id="msg"></div>
                </div>
            
                <!-- Modal footer -->
                <div class="modal-footer col-sm-12" id="modal_l_users_foot">	
                    <div id="mng"></div>
                </div>
            </form>
        </div>

    </div>
</div>

<script type="text/javascript">
	var data;
	var tmp_page=1;
	var tmp_filter='';
	// -------------------------- onload ---------------------------//
	var link_page=link+"/l_users.php";
	open_add();
	load_l_users('',tmp_page);
    load_l_position();
	load_l_province();
    load_l_department();
	

	// ------------------------- function -------------------------//
	$(document).on('keypress',function(e) {
        
	    if(e.which == 13) {
            
	        if($("#frm_mode").val()==2){
	    		update();
	    	}
            else{
	    		add();
	    	}
	    }
        
	});
    $("#txt_search").keyup(function(){
        $("#frm_mode").val(3);
    });
    $("#confirm_u_password").keyup(function(){
        if($("#u_password").val()!=$("#confirm_u_password").val()){
            $("#btn_save").prop('disabled', true)
        }else{
            $("#btn_save").prop('disabled', false)
        }    
    });
	function func_search(){
		load_l_users($("#txt_search").val(),tmp_page);
	}
	$("#frm_search" ).submit(function( event ) {
	  func_search();
	  event.preventDefault();
	});
	function open_add(){
        $("#frm_mode").val(1);
		clear_input();
		// console.log(l_department);
		$("#d_id").val(l_department);
		$("#pv_id").val(l_province);
		let txt=`<button id="btn_save" onclick="add()" type="button" class="btn btn-success" data-dismiss=""><i class="fas fa-save fa-1x"></i> บันทึก</button>`;
		$("#mng").html(txt);
	}
	function sh_data(u_id,u_fullname,p_id,u_tel,u_code,pv_id,d_id,p_des){
        $("#frm_mode").val(2);
		clear_input();
		let txt='';

			txt=`<button id="btn_del" data-dismiss="modal" data-toggle="modal" data-target="#del_modal" type="button" class="btn btn-danger" data-dismiss=""><i class="fas fa-trash-alt fa-1x"></i> ลบ</button>
			<button id="btn_save" onclick="update()" type="button" class="btn btn-success" data-dismiss=""><i class="fas fa-save fa-1x"></i> บันทึก</button>`;
			
		
		let hiden=`<input type="hidden" name="u_id" id="u_id" value="${u_id}">`;

		let p_des_new=`<textarea readonly class="form-control" rows="5" >${p_des}</textarea>`;
		$("#hidden").html(hiden);
		$("#u_fullname ").val(u_fullname );
		$("#d_id").val(d_id);
        $("#p_id").val(p_id);
		$("#pv_id").val(pv_id);
        $("#u_tel").val(u_tel);
        $("#u_code").val(u_code);
		$("#p_des").html(p_des_new);
		$("#modal_l_users").modal('toggle');
		$("#mng").html(txt);
	}
	function clear_input(){
		$("#hidden").html('');
		$("#u_fullname ").val('');
        $("#d_id").val('');
        $("#p_id").val('');
		$("#pv_id").val('');
        $("#u_tel").val('');
        $("#u_code").val('');
		$("#p_des").val('');
        $("#u_password").val('');
        $("#confirm_u_password").val('');
		$("#frm_l_users").removeClass("was-validated");
        $("#msg").html('');
	}
	function add(){
		$("#msg").html("");
		let sta=0;
        if($("#u_fullname").val()==""){sta++;}
		if($("#d_id").val()==""){sta++;}
        if($("#p_id").val()==""){sta++;}
        if($("#u_tel").val()==""){sta++;}
        if($("#u_code").val()==""){sta++;}
        if($("#u_password").val()==""){sta++;}
        if($("#confirm_u_password").val()==""){sta++;}
        if($("#pv_id").val()==""){sta++;}

		if(sta!=0){$("#frm_l_users").addClass("was-validated");return false;}
		else{
			let f_data=new FormData();
			let data = $("#frm_l_users").serializeArray();
			$.each(data,(key,val)=>{
                if(val.name=="u_password"){
                    val.value=re_encode(val.value);
                }
				f_data.append(val.name,val.value);
			});
			f_data.append("l_users_add",true);
			event.preventDefault();
			$.ajax({
				type: "POST",
	 			url:link_page,
	 			data: f_data,
				contentType: false,
				processData: false,
			}).done((res)=> {
				let data=JSON.parse(res);
				if(data.status){
					$("#modal_l_users").modal('toggle');
					load_l_users('',tmp_page);
					clear_input();
				}else{
					$("#msg").html("<div style='color:#bd4646'>"+data.msg+"</div>");
				}	 				
	 		});
		}
	}	
	function update(){
			$("#msg").html("");
			let f_data=new FormData();
			let data = $("#frm_l_users").serializeArray();
			$.each(data,(key,val)=>{
				if((val.name=="u_password" || val.name=="confirm_u_password") && val.value!="" ){
					val.value=re_encode(val.value);
				}
				f_data.append(val.name,val.value);
			});
			f_data.append("l_users_update",true);
			event.preventDefault();

				$.ajax({
					type: "POST",
		 			url:link_page,
		 			data: f_data,
					contentType: false,
					processData: false,
				}).done((res)=> {
					let data=JSON.parse(res);
					if(data.status){
						$("#modal_l_users").modal('toggle');
						load_l_users(tmp_filter,tmp_page);
						clear_input();
					}else{
						$("#msg").html("<div style='color:#bd4646'>"+data.msg+"</div>");
					}
				});	
	}	
	function del(){
			$("#msg").html("");
			$.ajax({
				type:"POST",
				url:link_page,
				data:{
					"u_id":$("#u_id").val(),
					"l_users_del":true
				}
			}).done((res)=>{
				let data=JSON.parse(res);
				if(data.status){
					// $("#modal_l_users").modal('toggle');
					load_l_users(tmp_filter,tmp_page);
					clear_input();
				}else{
					$("#msg").html("<div style='color:#bd4646'>"+data.msg+"</div>");
				}

			});
	}
	function load_l_users(filter,page){
        
			let txt;
			tmp_filter=filter;
			$("#loading").show();
			$.ajax({
				type:"POST",
				url:link_page,
				data:{
					"load_l_users":true,
					"filter":filter,
					"page":page
				}
			}).done((res)=>{
				var data=JSON.parse(res);
				if(!data.msg){
					$.each(data,(i, item)=>{
						let css=`style="background-color:#e0e9e5;color:#000"`;
						let row=(page==1?parseInt(i)+1:(parseInt(i)+1)+(page-1)*10);
						let limit_word="";
						
						txt+=`<tr ${css}>
					        <td>${row}</td>
					        <td>${item.u_fullname }</td>
                            <td>${item.p_name}</td>
                            <td>${item.u_tel}</td>															
					        <td><button style="color:#fff" type="button" onclick="sh_data('${item.u_id }','${item.u_fullname }','${item.p_id}','${item.u_tel}','${item.u_code}','${item.pv_id}','${item.d_id}','${item.p_des}')" class="btn">
				        		<i  class="fas fa-book-open fa-2x"></i>
				        	</button>`;
					});
				}else{
					txt=`<tr><td colspan='3' align="center">no data</td></tr>`;
				}
				$("#loading").hide();
				$("#l_users_content").html(txt);
				set_pagination(filter,page);
			});
	}
    function load_l_position(){
		let txt=`<option value="3" selected disabled>เลือกตำแหน่งผู้ใช้</option>`;
		$("#loading").show();
		$.ajax({
			type:"POST",
			url:link+"/l_position.php",
			data:{
				"load_l_position":true,
			}
		}).done((res)=>{
			var data=JSON.parse(res);
			if(!data.msg){
				$.each(data,(i, item)=>{
					txt+=`<option value="${item.p_id}">${item.p_name}</option>`;
				});
			}
			$("#loading").hide();
			$("#p_id").html(txt);
		});
	}
	function load_l_department(){
		let txt=`<option value="1" selected disabled>เลือกแผนก</option>`;
		$("#loading").show();
		$.ajax({
			type:"POST",
			url:link+"/l_department.php",
			data:{
				"load_l_department":true,
			}
		}).done((res)=>{
			var data=JSON.parse(res);
			if(!data.msg){
				$.each(data,(i, item)=>{
					txt+=`<option value="${item.d_id}">${item.d_name}</option>`;
				});
			}
			$("#loading").hide();
			$("#d_id").html(txt);
		});
	}
	function load_l_province(){
		let txt=`<option value="01" selected disabled>เลือกจังหวัดผู้ใช้</option>`;
		$("#loading").show();
		$.ajax({
			type:"POST",
			url:link+"/l_province.php",
			data:{
				"load_l_province":true,
			}
		}).done((res)=>{
			var data=JSON.parse(res);
			if(!data.msg){
				$.each(data,(i, item)=>{
					txt+=`<option value="${item.pv_id}">${item.pv_name}</option>`;
				});
			}
			$("#loading").hide();
			$("#pv_id").html(txt);
		});
	}
	function set_pagination(filter,page){
		let start_page;
		let end_page;
        
		$("#pagination").empty();
		$.ajax({
				type:"POST",
				url:link_page,
				data:{
					"set_pagination_l_users":true,
					"filter":filter
				}
			}).done((res)=>{
				var data=JSON.parse(res);
				tmp_page=(page==="pagi_first"?1:(page=="pagi_last"?data:page));
				if(tmp_page>5){
					start_page=tmp_page-4;
					end_page=tmp_page+5;
				}else{
					start_page=1;
					end_page=10;
				}
				$("#pagination").append(`<li class="page-item " id="pagi_first"><a class="page-link" onclick="load_l_users('${tmp_filter}',1)"><i class="fas fa-fast-backward"></i></a></li>`);
				for(let i=start_page;i<=data.page;i++){
					if(i<=end_page){
						$("#pagination").append(`<li class="page-item" id="pagi_${i}"><a class="page-link" onclick="load_l_users('${tmp_filter}',${i})">${i}</a></li>`);
						if(i==page){
							let active_page=`#pagi_${page}`;
							$(active_page).addClass("active");
						}
					}
				}
				$("#pagination").append(`<li class="page-item " id="pagi_last"><a class="page-link" onclick="load_l_users('${tmp_filter}',${data})"><i class="fas fa-fast-forward"></i></a></li>`);
			});	
	}
	
</script>

